<html>
  <head>
    <meta charset="UTF-8">
    <style>
      body {
        font-family: sans-serif;
        max-width: 1000px;
        margin: 40px auto;
        padding: 0 20px;
      }
      .page { display: none; }
      .page.active { display: block; }
      .step-content {
        display: flex;
        gap: 30px;
        align-items: flex-start;
        margin-top: 20px;
      }
      .audio-section {
        flex: 0 0 300px;
        display: flex;
        flex-direction: column;
      }
      .rating-section {
        flex: 1;
      }
      .step-button {
        margin-top: 20px;
        padding: 10px 20px;
        font-size: 1rem;
        float: right;
        clear: both;
      }
      .center-button {
        margin-top: 20px;
        padding: 12px 24px;
        font-size: 1.1rem;
        display: block;
        margin-left: auto;
        margin-right: auto;
        background: #007cba;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .center-button:hover {
        background: #005a87;
      }
      .rating-buttons {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 20px;
      }
      .rating-button {
        padding: 12px 16px;
        font-size: 1rem;
        border: 2px solid #ddd;
        background: white;
        cursor: pointer;
        text-align: left;
        border-radius: 4px;
        transition: all 0.2s;
      }
      .rating-button:hover {
        border-color: #007cba;
        background: #f0f8ff;
      }
      .rating-button.selected {
        border-color: #007cba;
        background: #007cba;
        color: white;
      }
      audio {
        width: 100%;
        margin-top: 15px;
      }
      .top-instructions {
        background: #fafafa;
        padding: 12px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 0.9rem;
      }
      .top-instructions-header {
        cursor: pointer;
        font-weight: normal;
        user-select: none;
        display: flex;
        align-items: center;
        gap: 6px;
        color: #666;
        font-size: 0.85rem;
      }
      .top-instructions-header:hover {
        color: #333;
      }
      .top-instructions-content {
        display: block;
        margin-top: 8px;
        color: #555;
        font-size: 1rem;
      }
      .top-instructions-content.show {
        display: block;
      }
      .top-instructions-content ul {
        margin: 8px 0;
        padding-left: 18px;
      }
      .top-instructions-content li {
        margin-bottom: 4px;
      }
      .toggle-icon {
        font-size: 0.7em;
        transition: transform 0.2s;
        color: #999;
      }
      .toggle-icon.rotated {
        transform: rotate(90deg);
      }
      .audio-label {
        font-weight: bold;
        color: #333;
      }
      .greeting-content, .thankyou-content {
        text-align: center;
        padding: 40px 20px;
      }
      .greeting-content h1, .thankyou-content h1 {
        color: #333;
        margin-bottom: 20px;
      }
      .greeting-content p, .thankyou-content p {
        font-size: 1.1rem;
        line-height: 1.6;
        margin-bottom: 15px;
        color: #555;
      }
      @media (max-width: 768px) {
        .step-content {
          flex-direction: column;
        }
        .audio-section {
          flex: none;
          width: 100%;
        }
        .step-button {
          float: none;
          width: 100%;
        }
      }
    </style>
    <script>
      const totalSteps = 40;
      const audioUrls = [
        "${audio_url_1}",
        "${audio_url_2}",
        "${audio_url_3}",
        "${audio_url_4}",
        "${audio_url_5}",
        "${audio_url_6}",
        "${audio_url_7}",
        "${audio_url_8}",
        "${audio_url_9}",
        "${audio_url_10}",
        "${audio_url_11}",
        "${audio_url_12}",
        "${audio_url_13}",
        "${audio_url_14}",
        "${audio_url_15}",
        "${audio_url_16}",
        "${audio_url_17}",
        "${audio_url_18}",
        "${audio_url_19}",
        "${audio_url_20}",
        "${audio_url_21}",
        "${audio_url_22}",
        "${audio_url_23}",
        "${audio_url_24}",
        "${audio_url_25}",
        "${audio_url_26}",
        "${audio_url_27}",
        "${audio_url_28}",
        "${audio_url_29}",
        "${audio_url_30}",
        "${audio_url_31}",
        "${audio_url_32}",
        "${audio_url_33}",
        "${audio_url_34}",
        "${audio_url_35}",
        "${audio_url_36}",
        "${audio_url_37}",
        "${audio_url_38}",
        "${audio_url_39}",
        "${audio_url_40}"
      ];

      let currentStep = 1;
      let selectedRatings = {};

      // Get assignment ID from URL parameters
      function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        const results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
      }

      // Set assignment ID when page loads
      function initializeAssignmentId() {
        const assignmentId = getUrlParameter('assignmentId');
        console.log('Assignment ID:', assignmentId);
        console.log('Current URL:', window.location.href);
        
        if (assignmentId) {
          document.querySelector('input[name="assignmentId"]').value = assignmentId;
        } else {
          console.warn('No assignmentId found in URL parameters');
          // For testing purposes, you can uncomment the line below:
          // document.querySelector('input[name="assignmentId"]').value = 'TEST_ASSIGNMENT_ID';
        }
      }

      // Load audio URLs from URL parameters (overrides placeholder values)
      function loadAudioUrls() {
        for (let i = 1; i <= totalSteps; i++) {
          const audioUrl = getUrlParameter('audio_url_' + i);
          if (audioUrl) {
            audioUrls[i-1] = audioUrl;
            console.log('Loaded audio_url_' + i + ':', audioUrl);
          }
        }
      }

      function showPage(pageId) {
        // Hide all pages
        document.querySelectorAll('.page').forEach(page => {
          page.classList.remove('active');
        });
        
        // Show target page
        document.getElementById(pageId).classList.add('active');
      }

      function startTask() {
        showPage('step-' + currentStep);
      }

      function toggleTopInstructions() {
        const content = document.getElementById('top-instructions-content');
        const icon = document.getElementById('top-toggle-icon');
        
        if (content.classList.contains('show')) {
          content.classList.remove('show');
          icon.classList.remove('rotated');
        } else {
          content.classList.add('show');
          icon.classList.add('rotated');
        }
      }

      function selectRating(stepNum, value, buttonElement) {
        // Remove selected class from all buttons in this step
        const buttons = buttonElement.parentElement.querySelectorAll('.rating-button');
        buttons.forEach(btn => btn.classList.remove('selected'));
        
        // Add selected class to clicked button
        buttonElement.classList.add('selected');
        
        // Store the selected value
        selectedRatings['audio_naturalness_' + stepNum] = value;
      }

      function nextStep() {
        // Check if a rating is selected for current step
        const currentRating = selectedRatings['audio_naturalness_' + currentStep];
        if (!currentRating) {
          alert('Please select a rating before proceeding.');
          return;
        }

        currentStep++;
        if (currentStep <= totalSteps) {
          showPage('step-' + currentStep);
        }
      }

      function submitForm() {
        // Check if a rating is selected for current step
        const currentRating = selectedRatings['audio_naturalness_' + currentStep];
        if (!currentRating) {
          alert('Please select a rating before proceeding.');
          return;
        }

        // Check if all ratings are selected
        for (let i = 1; i <= totalSteps; i++) {
          if (!selectedRatings['audio_naturalness_' + i]) {
            alert('Please complete all ratings before submitting.');
            return;
          }
        }

        // Check assignment ID
        const assignmentId = document.querySelector('input[name="assignmentId"]').value;
        if (!assignmentId) {
          alert('Error: No assignment ID found. This HIT must be accessed through MTurk.');
          console.error('Cannot submit without assignment ID');
          return;
        }

        // Add hidden inputs for each rating
        const form = document.forms.mturk_form;
        for (const [name, value] of Object.entries(selectedRatings)) {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = name;
          input.value = value;
          form.appendChild(input);
        }

        // Debug: Log form data before submission
        console.log('Submitting ratings:', selectedRatings);
        console.log('Assignment ID:', assignmentId);
        console.log('Form action:', form.action);
        
        const formData = new FormData(form);
        console.log('All form data:');
        for (let [key, value] of formData.entries()) {
          console.log(key + ': ' + value);
        }

        // Show thank you page
        showPage('thankyou');
      }

      function finalSubmit() {
        document.forms.mturk_form.submit();
      }

      function buildSteps() {
        const container = document.getElementById("steps-container");

        for (let i = 0; i < totalSteps; i++) {
          const stepDiv = document.createElement("div");
          stepDiv.className = "page";
          stepDiv.id = `step-${i + 1}`;

          const stepNum = i + 1;
          const audioUrl = audioUrls[i];
          const isLast = i === totalSteps - 1;

          stepDiv.innerHTML = `
            <div class="top-instructions">
              <div class="top-instructions-content" id="top-instructions-content-` + stepNum + `">
                <p>Listen to the sample of computer-generated speech and assess the quality based on how close it is to natural speech.</p>
                <p>Wear headphones and work in a quiet environment for best results.</p>
                <p><em>Note:</em> Some clips are short segments and may not form complete sentences. Please rate <strong>only</strong> the naturalness of the speech&mdash;<strong>not</strong> whether the sentence sounds complete or whether there are very minor distortions (such as slight background noise or subtle acoustic artifacts). Reserve lower scores only when the distortions noticeably reduce the naturalness.</p>
                <ul>
                  <li><strong>5 Excellent</strong> - Completely natural speech that is indistinguishable from real human speech. Minor audible distortions (e.g., slight background noise or subtle artifacts) may be present but do not reduce its naturalness.</li>
                  <li><strong>4 Good</strong> - Mostly natural speech, with only minor imperfections such as subtle prosodic or acoustic inconsistencies that slightly affect the natualness</li>
                  <li><strong>3 Fair</strong> - Equally natural and unnatural speech, which may be acceptable overall but has noticeable flaws</li>
                  <li><strong>2 Poor</strong> - Mostly unnatural speech that is intelligible but clearly synthetic, often due to issues in rhythm, intonation or clarity</li>
                  <li><strong>1 Bad</strong> - Completely unnatural speech that sounds robotic, distorted and/or significantly artificial</li>
                </ul>
                <!--<p>When deciding between the top ratings, please keep in mind: if a sample sounds completely natural overall, even if there are very minor distortions (such as slight background noise or subtle acoustic artifacts), it may still deserve a higher rating. Reserve lower scores only when the distortions noticeably reduce the naturalness.</p> -->
              </div>
            </div>

            <h3>How natural (i.e. human-sounding) is this recording?</h3>
            
            <div class="step-content">
              <div class="audio-section">
                <div class="audio-label">Audio Sample ` + stepNum + `:</div>
                <audio controls>
                  <source src="` + audioUrl + `" type="audio/mpeg" />
                  Your browser does not support audio playback.
                </audio>
              </div>
              
              <div class="rating-section">
                <p><strong>Make sure you listen to the full clip before selecting a rating:</strong></p>
                <div class="rating-buttons">
                  <button type="button" class="rating-button" onclick="selectRating(` + stepNum + `, 'Excellent', this)">
                    <strong>5 Excellent</strong> - Completely natural speech
                  </button>
                  <button type="button" class="rating-button" onclick="selectRating(` + stepNum + `, 'Good', this)">
                    <strong>4 Good</strong> - Mostly natural speech
                  </button>
                  <button type="button" class="rating-button" onclick="selectRating(` + stepNum + `, 'Fair', this)">
                    <strong>3 Fair</strong> - Equally natural and unnatural speech
                  </button>
                  <button type="button" class="rating-button" onclick="selectRating(` + stepNum + `, 'Poor', this)">
                    <strong>2 Poor</strong> - Mostly unnatural speech
                  </button>
                  <button type="button" class="rating-button" onclick="selectRating(` + stepNum + `, 'Bad', this)">
                    <strong>1 Bad</strong> - Completely unnatural speech
                  </button>
                </div>
              </div>
            </div>

            ` + (isLast
              ? '<button type="button" onclick="submitForm()" class="step-button">Finish</button>'
              : '<button type="button" onclick="nextStep()" class="step-button">Next</button>') + `
          `;

          container.appendChild(stepDiv);
        }
      }

      document.addEventListener("DOMContentLoaded", function() {
        initializeAssignmentId();
        loadAudioUrls();
        buildSteps();
        showPage('greeting');
      });
    </script>
  </head>

  <body>
    <form name="mturk_form" method="post" action="https://workersandbox.mturk.com/mturk/externalSubmit">
      <input type="hidden" name="assignmentId" value="" />
      
      <!-- Greeting Page -->
      <div id="greeting" class="page active">
        <div class="greeting-content">
          <h1>Welcome to the Speech Quality Assessment Task</h1>
          <p>Thank you for participating in this study. In this task, you will evaluate the naturalness of computer-generated speech samples.</p>
          <p>You will listen to 40 audio samples and rate how natural each one sounds. The task should take approximately 10 minutes to complete.</p>
          <p>
            Before you begin, please read the 
            <a href="https://docs.google.com/forms/d/e/1FAIpQLSfUcI7D4X-QI1dWBZRcLInNwSfpxqBwEKZZQBkgbyWxiFzM3g/viewform?usp=dialog" target="_blank">
              participant information sheet and consent form
            </a>. You will be asked to provide your consent in the Google Form.
          </p>
          <p>Please ensure you have headphones and are in a quiet environment before starting.</p>
          <p>
            <span style="color: red; font-weight: bold;">Important: Please click <em>“Start Task”</em> only after you have provided consent in the linked Google Form.</span>
          </p>
          <button type="button" onclick="startTask()" class="center-button">Start Task</button>
        </div>
      </div>

      <!-- Steps will be built here -->
      <div id="steps-container"></div>

      <!-- Thank You Page -->
      <div id="thankyou" class="page">
        <div class="thankyou-content">
          <h1>Thank You!</h1>
          <p>You have successfully completed the speech quality assessment task.</p>
          <p>Your responses have been recorded and will help improve speech synthesis technology.</p>
          <p>Click the button below to submit your work and receive payment.</p>
          <button type="button" onclick="finalSubmit()" class="center-button">Submit HIT</button>
        </div>
      </div>
    </form>
  </body>
</html>